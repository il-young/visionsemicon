//---------------------------------------------------------------------------


#pragma hdrstop

#include "DBModule.h"

//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma classgroup "System.Classes.TPersistent"
#pragma resource "*.dfm"
TDBManager *DBManager;
//---------------------------------------------------------------------------
__fastcall TDBManager::TDBManager(TComponent* Owner)
	: TDataModule(Owner)
{

}

bool __fastcall TDBManager::ConnectDB()
{
	if(dbConnection->Connected)
		dbConnection->Close();
	dbConnection->LoginPrompt = false;

	String strConn  = "Provider=Microsoft.Jet.OLEDB.4.0;";
	strConn += "Data Source=" + GetCurrentDir() + "\\User.MDB";
	strConn += ";Persist Security Info=False;";
	strConn += "Jet OLEDB:Database";

	dbConnection->ConnectionString = strConn;

	try
	{
		dbConnection->Open();
		if(dbConnection->State == (TObjectStates() << stOpen))
		{
			dbConnection->Connected = true;

		}
	}
	catch(Exception *e)
	{
		return false;
	}
}

bool __fastcall TDBManager::LoginCheckUser(AnsiString ID, AnsiString PASS, stUserInfo &info){
	if(!dbConnection->Connected) return false;

	String WHERE = " WHERE [USER_ID]= '" + ID  + "'";
	WHERE += " and [USER_PASS]= '" + PASS + "';";

	dbQuery->Connection = dbConnection;
	dbQuery->Close();
	dbQuery->SQL->Clear();
	dbQuery->SQL->Add("SELECT * from tblUser " + WHERE);
	dbQuery->Open();

	if(dbQuery->RecordCount > 0){
		info.USER_ID = dbQuery->FieldByName("USER_ID")->AsString;
		info.USER_PASS = dbQuery->FieldByName("USER_PASS")->AsString;
		info.USER_GROUP = dbQuery->FieldByName("USER_GROUP")->AsString;
		info.USER_DESCRIPTIONS = dbQuery->FieldByName("USER_DESCRIPTIONS")->AsString;
		info.USER_LOGOUTTIME = dbQuery->FieldByName("USER_LOGOUTTIME")->AsString;

		return true;
    }
	else return false;
}

stUserInfo __fastcall TDBManager::GetUserInfo(AnsiString ID){
	stUserInfo info;

	if(!dbConnection->Connected) return info;

	String WHERE = " WHERE [USER_ID]= '" + ID  + "';";

	dbQuery->Connection = dbConnection;
	dbQuery->Close();
	dbQuery->SQL->Clear();
	dbQuery->SQL->Add("SELECT * from tblUser " + WHERE);
	dbQuery->Open();

	if(dbQuery->RecordCount > 0){
		info.USER_ID = dbQuery->FieldByName("USER_ID")->AsString;
		info.USER_PASS = dbQuery->FieldByName("USER_PASS")->AsString;
		info.USER_GROUP = dbQuery->FieldByName("USER_GROUP")->AsString;
		info.USER_DESCRIPTIONS = dbQuery->FieldByName("USER_DESCRIPTIONS")->AsString;
		info.USER_LOGOUTTIME = dbQuery->FieldByName("USER_LOGOUTTIME")->AsString;

		return info;
    }
	else return info;
}

deque<stUserInfo> __fastcall TDBManager::SelectUsers()
{
	deque<stUserInfo> list;
	list.clear();

	try
	{
		if(!dbConnection->Connected)
			return list;

		dbQuery->Connection = dbConnection;
		dbQuery->Close();
		dbQuery->SQL->Clear();
		dbQuery->SQL->Add("SELECT * from tblUser");
		dbQuery->Open();

		if(dbQuery->RecordCount > 0)
		{
			dbQuery->First();

			while(!dbQuery->Eof)
			{
                stUserInfo info;

				info.USER_ID = dbQuery->FieldByName("USER_ID")->AsString;
				info.USER_PASS = dbQuery->FieldByName("USER_PASS")->AsString;
				info.USER_GROUP = dbQuery->FieldByName("USER_GROUP")->AsString;
				info.USER_DESCRIPTIONS = dbQuery->FieldByName("USER_DESCRIPTIONS")->AsString;
				info.USER_LOGOUTTIME = dbQuery->FieldByName("USER_LOGOUTTIME")->AsString;

				list.push_back(info);

				dbQuery->Next();
			}
		}

		if(dbQuery->RecordCount > 0)
		{
			return list;
		}
		else
		{
			return list;
		}
	}
	catch(Exception *e)
	{
		return list;
	}
}

//사용자 추가
bool __fastcall TDBManager::AddUser(stUserInfo info)
{
	if(!dbConnection->Connected)	return false;

	String Field = " ([USER_ID], [USER_PASS], [USER_GROUP], [USER_DESCRIPTIONS], [USER_LOGOUTTIME] )";
	String Value = "'" + info.USER_ID + "','" + info.USER_PASS + "','";
	Value += info.USER_GROUP + "','" + info.USER_DESCRIPTIONS + "','";
	Value += info.USER_LOGOUTTIME + "'";

	dbQuery->Connection = dbConnection;
	dbQuery->Close();
	dbQuery->SQL->Clear();
	dbQuery->SQL->Add("INSERT INTO tblUser " + Field + " VALUES ("+Value+");");
	dbQuery->Prepared = true;

	if(dbQuery->ExecSQL() > 0)
	{
		return true;
	}
	else
	{
		return false;
	}
}

//사용자 수정
bool __fastcall TDBManager::EditUser(stUserInfo info)
{
	if(!dbConnection->Connected)	return false;

	String Value = "SET [USER_GROUP] = '" + info.USER_GROUP + "',";
	Value += "[USER_DESCRIPTIONS] = '" 	+ info.USER_DESCRIPTIONS + "',";
	Value += "[USER_LOGOUTTIME] = '" + info.USER_LOGOUTTIME + "'";
	String WHERE = " WHERE [USER_ID]= '" + info.USER_ID + "';";

	dbQuery->Connection = dbConnection;
	dbQuery->Close();
	dbQuery->SQL->Clear();
	dbQuery->SQL->Add("UPDATE tblUser " + Value + WHERE);
	dbQuery->Prepared = true;

	if(dbQuery->ExecSQL() > 0)
	{
		return true;
	}
	else
	{
		return false;
	}
}
//사용자 삭제
bool __fastcall TDBManager::DeleteUser(AnsiString ID)
{
	if(!dbConnection->Connected)	return false;

	String WHERE = " WHERE [USER_ID]= '" + ID + "';";

	dbQuery->Connection = dbConnection;
	dbQuery->Close();
	dbQuery->SQL->Clear();
	dbQuery->SQL->Add("DELETE from tblUser " + WHERE);
	dbQuery->Prepared = true;

	if(dbQuery->ExecSQL() > 0)
	{
		return true;
	}
	else
	{
		return false;
	}
}

//SECS 정보 얻기
stSECSInfo __fastcall TDBManager::SelectSECSInfo()
{
	stSECSInfo info;
	info.SECS_TYPE = "";
	info.SECS_IP = "";
	info.SECS_PORT = 0;
	info.SECS_T3 = 0;
	info.SECS_T4 = 0;
	info.SECS_T5 = 0;
	info.SECS_T6 = 0;
	info.SECS_T7 = 0;
	info.SECS_T8 = 0;

	try
	{
		if(!dbConnection->Connected)
			return info;

		dbQuery->Connection = dbConnection;
		dbQuery->Close();
		dbQuery->SQL->Clear();
		dbQuery->SQL->Add("SELECT * from tblSECS");
		dbQuery->Open();

		if(dbQuery->RecordCount > 0)
		{
			dbQuery->First();

			info.SECS_TYPE = dbQuery->FieldByName("SECS_TYPE")->AsString;
			info.SECS_IP = dbQuery->FieldByName("SECS_IP")->AsString;
			info.SECS_PORT = dbQuery->FieldByName("SECS_PORT")->AsString;
			info.SECS_T3 = dbQuery->FieldByName("SECS_T3")->AsString;
			info.SECS_T4 = dbQuery->FieldByName("SECS_T4")->AsString;
			info.SECS_T5 = dbQuery->FieldByName("SECS_T5")->AsString;
			info.SECS_T6 = dbQuery->FieldByName("SECS_T6")->AsString;
			info.SECS_T7 = dbQuery->FieldByName("SECS_T7")->AsString;
			info.SECS_T8 = dbQuery->FieldByName("SECS_T8")->AsString;
		}

		if(dbQuery->RecordCount > 0)
		{
			return info;
		}
		else
		{
			return info;
		}
	}
	catch(Exception *e)
	{
		return info;
	}
}

//SECS 정보 수정
bool __fastcall TDBManager::EditSECS(stSECSInfo info)
{
	if(!dbConnection->Connected)	return false;

	String Value = "SET [SECS_TYPE] = '" + info.SECS_TYPE + "',";
	Value += "[SECS_IP] = '" 		+ info.SECS_IP + "',";
	Value += "[SECS_PORT] = '" 	+ info.SECS_PORT + "',";
	Value += "[SECS_T3] = '" 	+ info.SECS_T3 + "',";
	Value += "[SECS_T4] = '" 	+ info.SECS_T4 + "',";
	Value += "[SECS_T5] = '" 	+ info.SECS_T5 + "',";
	Value += "[SECS_T6] = '" 	+ info.SECS_T6 + "',";
	Value += "[SECS_T7] = '" 	+ info.SECS_T7 + "',";
	Value += "[SECS_T8] = '" 	+ info.SECS_T8 + "'";
	String WHERE = " WHERE [SECS_NO]= 'set';";

	dbQuery->Connection = dbConnection;
	dbQuery->Close();
	dbQuery->SQL->Clear();
	dbQuery->SQL->Add("UPDATE tblSECS " + Value + WHERE);
	dbQuery->Prepared = true;

	if(dbQuery->ExecSQL() > 0)
	{
		return true;
	}
	else
	{
		return false;
	}
}
